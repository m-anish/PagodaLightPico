<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Build sun_times.json ‚Ä¢ PagodaLightPico</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 20px; background: #f5f5f5; }
    .container { max-width: 920px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    h1 { color: #2c3e50; text-align: center; }
    fieldset { border: 1px solid #e5e7eb; border-radius: 10px; margin: 16px 0; padding: 12px; background: #fafafa; }
    fieldset.meta { border-left: 4px solid #60a5fa; }
    fieldset.location { border-left: 4px solid #34d399; }
    fieldset.tz { border-left: 4px solid #f59e0b; }
    fieldset.options { border-left: 4px solid #a78bfa; }
    fieldset.generated { border-left: 4px solid #22d3ee; }
    label { display: block; margin: 6px 0; }
    input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; max-width: 100%; }
    .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); column-gap: 12px; row-gap: 12px; align-items: start; }
    @media (max-width: 640px){ .row { grid-template-columns: 1fr; } }
    .actions { display: flex; gap: 12px; flex-wrap: wrap; }
    button, a.button, label.button { padding: 10px 14px; border: 1px solid #999; border-radius: 8px; background: #fff; cursor: pointer; text-decoration: none; color: #222; display:inline-flex; align-items:center; gap:6px; }
    pre { background: #0b1020; color: #d5e6ff; padding: 12px; border-radius: 8px; overflow: auto; max-height: 420px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 6px; text-align: left; }
    .tip { font-size: 12px; color: #666; }
    legend { font-weight: 600; color: #374151; }
    .legend-row { display:flex; align-items:center; gap:8px; }
    .collapse-toggle { border:none; background:none; cursor:pointer; font-size:14px; }
    fieldset.collapsed > :not(legend) { display: none; }
    .emoji { font-size: 1.1em; margin-right: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="emoji">üåÖ</span>Build sun_times.json</h1>

    <form id="stForm" oninput="render()" onchange="render()">
      <fieldset class="meta">
        <legend><span class="legend-row"><button type="button" class="collapse-toggle" aria-label="toggle">‚ñº</button><span class="emoji">üß©</span>Meta</span></legend>
        <div class="row">
          <label>Version (semver)
            <input id="version" type="text" placeholder="0.4.1" />
          </label>
        </div>
      </fieldset>

      <fieldset class="location">
        <legend><span class="legend-row"><button type="button" class="collapse-toggle" aria-label="toggle">‚ñº</button><span class="emoji">üìç</span>Location</span></legend>
        <div class="row">
          <label>Search place or address
            <input id="place" type="text" placeholder="e.g., Dharamsala, India" list="placeList" />
            <datalist id="placeList"></datalist>
          </label>
          <div>
            <label>&nbsp;</label>
            <button type="button" id="applyPlace">Use selected place</button>
          </div>
        </div>
        <div class="row">
          <label>Chosen name
            <input id="location" type="text" placeholder="Location name" />
          </label>
        </div>
        <div class="row">
          <label>Latitude
            <input id="lat" type="number" step="0.0001" placeholder="0.0000" />
          </label>
          <label>Longitude
            <input id="lon" type="number" step="0.0001" placeholder="0.0000" />
          </label>
        </div>
        <fieldset class="tz" style="margin:0;">
          <legend><span class="legend-row"><button type="button" class="collapse-toggle" aria-label="toggle">‚ñº</button><span class="emoji">üåç</span>Timezone</span></legend>
          <div class="row">
            <label>Timezone
              <input id="tz" type="text" placeholder="Asia/Kolkata" list="tzList" />
              <datalist id="tzList"></datalist>
            </label>
          </div>
        </fieldset>
        <div class="tip">Pick timezone closest to your location (e.g., Asia/Kolkata). Autodetect is not guaranteed.</div>
      </fieldset>

      <fieldset class="options">
        <legend><span class="legend-row"><button type="button" class="collapse-toggle" aria-label="toggle">‚ñº</button><span class="emoji">‚öôÔ∏è</span>Options</span></legend>
        <div class="row">
          <label>Frequency
            <select id="freq">
              <option value="monthly" selected>Monthly (1st of each month)</option>
              <option value="fortnightly">Fortnightly (1st and 15th)</option>
              <option value="weekly">Weekly (Mondays)</option>
              <option value="daily">Daily</option>
            </select>
          </label>
          <label>Year (for calculations)
            <select id="year"></select>
          </label>
        </div>
        <div>
          <button type="button" id="generateBtn">Generate from location</button>
        </div>
      </fieldset>

      <fieldset class="generated">
        <legend><span class="legend-row"><button type="button" class="collapse-toggle" aria-label="toggle">‚ñº</button><span class="emoji">üìÖ</span>Generated Days</span></legend>
        <table id="daysTable">
          <thead>
            <tr><th>Date (MM-DD)</th><th>Sunrise</th><th>Sunset</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </form>

    <div class="actions">
      <button onclick="downloadJSON()">Download sun_times.json</button>
      <a class="button" href="./index.html">Back to Home</a>
    </div>

    <h2>Preview</h2>
    <pre id="preview"></pre>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
  <script>
    const days = {};
    let SAMPLE_VERSION = null;
    const placeMap = new Map();
    // Canonicalize time zone to a supported IANA name used by Intl
    function canonicalizeTimeZone(tz){
      if (!tz) return tz;
      const aliasMap = {
        'Asia/Calcutta': 'Asia/Kolkata',
        'Asia/Bombay': 'Asia/Kolkata',
        'Europe/Kiev': 'Europe/Kyiv',
        'Asia/Rangoon': 'Asia/Yangon'
      };
      let zones = [];
      if (typeof Intl !== 'undefined' && Intl.supportedValuesOf) {
        try { zones = Intl.supportedValuesOf('timeZone'); } catch {}
      }
      const isSupported = (z) => zones && zones.length ? zones.includes(z) : true;
      if (isSupported(tz)) return tz;
      const mapped = aliasMap[tz];
      if (mapped && isSupported(mapped)) return mapped;
      return tz; // fallback
    }

    function validateKey(key){ return /^\d{2}-\d{2}$/.test(key); }
    function validateTime(t){ return /^\d{2}:\d{2}$/.test(t); }

    // --- Dynamic loader & guards for spacetime ---
    function loadScript(src){
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src; s.onload = resolve; s.onerror = reject; document.head.appendChild(s);
      });
    }
    let spacetimeLoading = null;
    async function ensureSpacetime(){
      if (typeof spacetime !== 'undefined' && spacetime) return true;
      if (spacetimeLoading) { try { await spacetimeLoading; } catch {} return typeof spacetime !== 'undefined'; }
      spacetimeLoading = (async () => {
        const candidates = [
          // Local vendored copy (preferred)
          './vendor/spacetime.min.js',
          'https://cdn.jsdelivr.net/npm/spacetime@7.5.1/builds/spacetime.min.js',
          'https://unpkg.com/spacetime@7.5.1/builds/spacetime.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/spacetime/7.5.1/spacetime.min.js'
        ];
        for (const url of candidates){ try { await loadScript(url); if (typeof spacetime !== 'undefined') break; } catch {}
        }
        if (typeof spacetime !== 'undefined'){
          // load plugin
          const geoCandidates = [
            './vendor/spacetime-geo.min.js',
            'https://cdn.jsdelivr.net/npm/spacetime-geo@0.1.2/spacetime-geo.min.js',
            'https://unpkg.com/spacetime-geo@0.1.2/spacetime-geo.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/spacetime-geo/0.1.2/spacetime-geo.min.js'
          ];
          for (const url of geoCandidates){ try { await loadScript(url); if (spacetime.where) break; } catch {} }
        }
      })();
      try { await spacetimeLoading; } catch {}
      return typeof spacetime !== 'undefined';
    }

    function renderDays(){
      const tb = document.querySelector('#daysTable tbody');
      tb.innerHTML = '';
      Object.keys(days).sort().forEach(k => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${days[k].rise}</td><td>${days[k].set}</td>`;
        tb.appendChild(tr);
      });
    }

    // Collapsible sections
    function setupCollapsibles(){
      document.querySelectorAll('fieldset').forEach(fs => {
        const btn = fs.querySelector('.collapse-toggle');
        if (!btn) return;
        btn.addEventListener('click', () => {
          fs.classList.toggle('collapsed');
          btn.textContent = fs.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
        });
      });
    }

    async function loadSampleVersion(){
      try {
        // GitHub Pages workflow copies sample JSONs to site root (same dir as this page)
        let resp = await fetch('sun_times.json.sample');
        if (!resp.ok) resp = await fetch('./sun_times.json.sample');
        if (!resp.ok) resp = await fetch('/sun_times.json.sample');
        if (resp.ok) {
          const data = await resp.json();
          if (data && typeof data.version === 'string') {
            SAMPLE_VERSION = data.version;
            const verInput = document.getElementById('version');
            if (verInput && !verInput.value) {
              verInput.value = SAMPLE_VERSION;
            }
          }
        }
      } catch (e) {
        // Ignore fetch errors (e.g., file:// access); fallback remains
      } finally {
        render();
      }
    }

    // ---- Place autocomplete via Nominatim ----
    function populateTZList(){
      const dl = document.getElementById('tzList');
      dl.innerHTML = '';
      let zones = [];
      if (typeof Intl !== 'undefined' && Intl.supportedValuesOf) {
        try { zones = Intl.supportedValuesOf('timeZone'); } catch {}
      }
      if (!zones || zones.length === 0) {
        zones = [
          'UTC',
          // Africa
          'Africa/Abidjan','Africa/Accra','Africa/Addis_Ababa','Africa/Algiers','Africa/Cairo','Africa/Casablanca','Africa/Johannesburg','Africa/Lagos','Africa/Nairobi',
          // America
          'America/Anchorage','America/Argentina/Buenos_Aires','America/Bogota','America/Caracas','America/Chicago','America/Denver','America/Halifax','America/Los_Angeles','America/Mexico_City','America/New_York','America/Phoenix','America/Santiago','America/Sao_Paulo','America/Toronto',
          // Asia
          'Asia/Almaty','Asia/Amman','Asia/Baghdad','Asia/Bangkok','Asia/Beirut','Asia/Colombo','Asia/Dhaka','Asia/Dubai','Asia/Ho_Chi_Minh','Asia/Hong_Kong','Asia/Jakarta','Asia/Jerusalem','Asia/Kabul','Asia/Karachi','Asia/Kathmandu','Asia/Kolkata','Asia/Kuala_Lumpur','Asia/Macau','Asia/Manila','Asia/Riyadh','Asia/Seoul','Asia/Shanghai','Asia/Singapore','Asia/Taipei','Asia/Tehran','Asia/Tokyo',
          // Australia-Pacific
          'Australia/Adelaide','Australia/Brisbane','Australia/Darwin','Australia/Hobart','Australia/Melbourne','Australia/Perth','Australia/Sydney','Pacific/Auckland','Pacific/Honolulu','Pacific/Noumea','Pacific/Port_Moresby',
          // Europe
          'Europe/Amsterdam','Europe/Athens','Europe/Belgrade','Europe/Berlin','Europe/Brussels','Europe/Bucharest','Europe/Budapest','Europe/Copenhagen','Europe/Dublin','Europe/Gibraltar','Europe/Helsinki','Europe/Istanbul','Europe/Kiev','Europe/Lisbon','Europe/London','Europe/Luxembourg','Europe/Madrid','Europe/Malta','Europe/Minsk','Europe/Moscow','Europe/Oslo','Europe/Paris','Europe/Prague','Europe/Riga','Europe/Rome','Europe/Stockholm','Europe/Tallinn','Europe/Vienna','Europe/Vilnius','Europe/Warsaw','Europe/Zurich'
        ];
      }
      zones.forEach(z => { const opt = document.createElement('option'); opt.value = z; dl.appendChild(opt); });
    }

    let suggestTimer = null;
    document.getElementById('place').addEventListener('input', e => {
      const q = e.target.value.trim();
      clearTimeout(suggestTimer);
      if (!q) return;
      suggestTimer = setTimeout(async () => {
        try {
          // Note: Browsers do not allow setting User-Agent header. Keep requests light and cache-friendly.
          const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=5&q=${encodeURIComponent(q)}`;
          const resp = await fetch(url, { headers: { 'Accept': 'application/json' }});
          if (!resp.ok) return;
          const arr = await resp.json();
          placeMap.clear();
          const dl = document.getElementById('placeList');
          dl.innerHTML = '';
          arr.forEach(item => {
            const name = item.display_name;
            placeMap.set(name, { lat: parseFloat(item.lat), lon: parseFloat(item.lon) });
            const opt = document.createElement('option');
            opt.value = name; dl.appendChild(opt);
          });
        } catch {}
      }, 250);
    });

    async function autoFillTimezone(){
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      if (isNaN(lat) || isNaN(lon)) return;
      try {
        const ok = await ensureSpacetime();
        if (ok && spacetime && spacetime.where) {
          const info = spacetime.where(lat, lon);
          if (info && info.timezone && info.timezone.name) {
            document.getElementById('tz').value = canonicalizeTimeZone(info.timezone.name);
          }
        }
      } catch {}
    }

    document.getElementById('applyPlace').addEventListener('click', () => {
      const val = document.getElementById('place').value.trim();
      if (placeMap.has(val)) {
        const p = placeMap.get(val);
        document.getElementById('location').value = val;
        document.getElementById('lat').value = p.lat.toFixed(4);
        document.getElementById('lon').value = p.lon.toFixed(4);
        autoFillTimezone();
      }
      render();
    });

    // If user edits coordinates manually, try to auto-fill timezone as well
    ['lat','lon'].forEach(id => document.getElementById(id).addEventListener('change', autoFillTimezone));

    // ---- Generation ----
    function pad2(n){ return n.toString().padStart(2,'0'); }
    function formatHM(date, tz){
      try {
        const parts = new Intl.DateTimeFormat('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: tz }).formatToParts(date);
        const h = parts.find(p=>p.type==='hour')?.value || '00';
        const m = parts.find(p=>p.type==='minute')?.value || '00';
        return `${h}:${m}`;
      } catch { return '00:00'; }
    }

    // Intl helpers (spacetime-free)
    function localParts(date, tz){
      const fmt = new Intl.DateTimeFormat('en-GB', { timeZone: tz, year:'numeric', month:'2-digit', day:'2-digit', weekday:'long' });
      const parts = fmt.formatToParts(date);
      const get = (t) => parts.find(p=>p.type===t)?.value;
      return { y: parseInt(get('year')), m: parseInt(get('month')), d: parseInt(get('day')), weekday: get('weekday') };
    }
    function* daysOfYearUTC(year){
      let d = new Date(Date.UTC(year,0,1));
      while (d.getUTCFullYear() === year){ yield new Date(d.getTime()); d.setUTCDate(d.getUTCDate()+1); }
    }
    function generateDatesLocalFallback(year, freq, tz){
      const out = [];
      if (freq === 'daily'){
        for (const d of daysOfYearUTC(year)) out.push(d);
      } else if (freq === 'weekly'){
        for (const d of daysOfYearUTC(year)) { const lp = localParts(d, tz); if (lp.weekday === 'Monday') out.push(d); }
      } else if (freq === 'fortnightly'){
        // pick all days where local day is 1 or 15; de-dup months per key
        const pick = new Map(); // key: `${m}-${d}` => first date
        for (const d of daysOfYearUTC(year)){
          const lp = localParts(d, tz);
          if (lp.d === 1 || lp.d === 15){ const k = `${lp.m}-${lp.d}`; if (!pick.has(k)) pick.set(k, d); }
        }
        // order Jan..Dec (1 and 15 per month)
        for (let m=1;m<=12;m++){ const k1=`${m}-1`, k2=`${m}-15`; if (pick.has(k1)) out.push(pick.get(k1)); if (pick.has(k2)) out.push(pick.get(k2)); }
      } else { // monthly -> local day 1 of each month
        const pick = new Map();
        for (const d of daysOfYearUTC(year)){
          const lp = localParts(d, tz);
          if (lp.d === 1){ const k = `${lp.m}-1`; if (!pick.has(k)) pick.set(k, d); }
        }
        for (let m=1;m<=12;m++){ const k=`${m}-1`; if (pick.has(k)) out.push(pick.get(k)); }
      }
      return out.map(d => ({ date: d }));
    }

    function generateDatesLocal(year, freq, tz){
      if (typeof spacetime !== 'undefined' && spacetime){
        const out = [];
        let s = spacetime(`${year}-01-01`, tz).startOf('day');
        const end = s.endOf('year');
        if (freq === 'daily') {
          while (s.year() === year) { out.push(s.clone()); s = s.add(1, 'day'); }
        } else if (freq === 'weekly') {
          while (s.isBefore(end)) { if (s.dayName() === 'Monday') out.push(s.clone()); s = s.add(1, 'day'); }
        } else if (freq === 'fortnightly') {
          for (let m=0;m<12;m++){ out.push(spacetime({year, month:m, date:1}, tz)); out.push(spacetime({year, month:m, date:15}, tz)); }
        } else { // monthly
          for (let m=0;m<12;m++){ out.push(spacetime({year, month:m, date:1}, tz)); }
        }
        return out;
      }
      // Fallback using Intl + UTC dates
      return generateDatesLocalFallback(year, freq, tz);
    }

    async function generateFromLocation(){
      const loc = document.getElementById('location').value.trim() || 'Unknown';
      const lat = parseFloat(document.getElementById('lat').value);
      const lon = parseFloat(document.getElementById('lon').value);
      const tz = canonicalizeTimeZone(document.getElementById('tz').value.trim() || 'UTC');
      const year = parseInt(document.getElementById('year').value || new Date().getFullYear(), 10);
      if (isNaN(lat) || isNaN(lon)) { alert('Please choose a valid place (lat/lon).'); return; }
      // Try to load spacetime but proceed even if it fails (fallback path)
      try { await ensureSpacetime(); } catch {}
      daysClear();
      const dates = generateDatesLocal(year, document.getElementById('freq').value, tz);
      dates.forEach(s => {
        const native = (typeof s.clone === 'function')
          ? s.clone().hour(12).minute(0).second(0).millisecond(0).toNativeDate()
          : new Date(s.date.getTime()); // UTC date; SunCalc works with Date regardless of tz
        const times = SunCalc.getTimes(native, lat, lon);
        const lp = (typeof s.month === 'function')
          ? { m: s.month()+1, d: s.date() }
          : localParts(native, tz);
        const mmdd = `${pad2(lp.m)}-${pad2(lp.d)}`;
        days[mmdd] = { rise: formatHM(times.sunrise, tz), set: formatHM(times.sunset, tz) };
      });
      document.getElementById('location').value = loc; // keep
      renderDays();
      render();
    }

    function daysClear(){ for (const k of Object.keys(days)) delete days[k]; }

    function buildSunTimes(){
      return {
        version: document.getElementById('version').value || SAMPLE_VERSION || '0.4.1',
        location: document.getElementById('location').value || 'Unknown',
        lat: parseFloat(document.getElementById('lat').value||'0'),
        lon: parseFloat(document.getElementById('lon').value||'0'),
        days: days
      };
    }

    function render(){
      document.getElementById('preview').textContent = JSON.stringify(buildSunTimes(), null, 2);
    }

    function downloadJSON(){
      const blob = new Blob([JSON.stringify(buildSunTimes(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'sun_times.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function populateYearSelect(){
      const sel = document.getElementById('year');
      const y = new Date().getFullYear();
      const years = [y-1, y, y+1];
      sel.innerHTML = '';
      years.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v; if (v===y) opt.selected = true; sel.appendChild(opt);
      });
    }

    document.getElementById('generateBtn').addEventListener('click', generateFromLocation);
    populateTZList();
    populateYearSelect();
    loadSampleVersion();
    setupCollapsibles();
    render();
  </script>
</body>
</html>
